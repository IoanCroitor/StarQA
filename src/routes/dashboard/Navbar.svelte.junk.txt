<script lang="ts">
  import * as Avatar from '$lib/components/ui/avatar/index.js'
  import { Button } from '$lib/components/ui/button/index.js'
  import * as DropdownMenu from '$lib/components/ui/dropdown-menu/index.js'
  import {
    getProfilePictureByUserId,
    getUsernameByUserId,
    getNameById,
  } from './querryUtils'

  export let data

  let user_username: string,
    user_name: string,
    user_name_avatar_fallback: string
  let profile_picture: string
  const { supabase, user } = data

  const specificUserId = user?.id as string

  getUsernameByUserId(specificUserId, supabase).then((username) => {
    if (username) {
      user_username = username
    }
  })
  getProfilePictureByUserId(specificUserId, supabase).then(
    (profilePictureUrl: string) => {
      if (profilePictureUrl) {
        profile_picture = profilePictureUrl
      }
    },
  )
  getNameById(specificUserId, supabase).then((name) => {
    if (name) {
      user_name = name
    }
  })

  function getFirstCharacters(str: string): string {
    if (str && typeof str === 'string') {
      // Split the string into words
      const words = str.trim().split(/\s+/)

      // Get the first character of each word and join with spaces
      return words.map((word) => word.charAt(0).toUpperCase()).join(' ')
    }
    return ''
  }

  $: user_name_avatar_fallback = getFirstCharacters(user_name)
</script>

<div class="bg-muted/60 backdrop-blur-lg w-full z-40 fixed">
  <nav
    class="flex gap-4 top-0 h-14
  items-center text-slate-200 px-4 justify-between max-w-[100rem] mx-auto"
  >
    <a class="hover:underline font-semibold decoration-wavy" href="/dashboard"
      >StarQA</a
    >

    <div class="flex flex-row gap-2">
      <Button variant="ghost" href="/dashboard">Explore</Button>
      <Button variant="ghost" href="/create">Create a quiz</Button>
      <Button variant="ghost" href="/my-quizzes">My quizzes</Button>
    </div>
    <DropdownMenu.Root>
      <DropdownMenu.Trigger asChild let:builder>
        <Button builders={[builder]} variant="ghost" class="h-6 w-6">
          <Avatar.Root>
            <Avatar.Image src={profile_picture} alt={`@${user_username}`} />
            <Avatar.Fallback>{user_name_avatar_fallback}</Avatar.Fallback>
          </Avatar.Root></Button
        >
      </DropdownMenu.Trigger>
      <DropdownMenu.Content class="w-56">
        <DropdownMenu.Label>{user?.email}</DropdownMenu.Label>
        <DropdownMenu.Separator />
        <DropdownMenu.Group>
          <DropdownMenu.Item href="/profile">
            Profile
            <DropdownMenu.Shortcut>⇧P</DropdownMenu.Shortcut>
          </DropdownMenu.Item>
          <DropdownMenu.Item>
            Billing
            <DropdownMenu.Shortcut>⌘B</DropdownMenu.Shortcut>
          </DropdownMenu.Item>
          <DropdownMenu.Item>
            Settings
            <DropdownMenu.Shortcut>⌘S</DropdownMenu.Shortcut>
          </DropdownMenu.Item>
          <DropdownMenu.Item>
            Keyboard shortcuts
            <DropdownMenu.Shortcut>⌘K</DropdownMenu.Shortcut>
          </DropdownMenu.Item>
        </DropdownMenu.Group>
        <DropdownMenu.Separator />
        <DropdownMenu.Group>
          <DropdownMenu.Item>Team</DropdownMenu.Item>
          <DropdownMenu.Sub>
            <DropdownMenu.SubTrigger>Invite users</DropdownMenu.SubTrigger>
            <DropdownMenu.SubContent>
              <DropdownMenu.Item>Email</DropdownMenu.Item>
              <DropdownMenu.Item>Message</DropdownMenu.Item>
              <DropdownMenu.Separator />
              <DropdownMenu.Item>More...</DropdownMenu.Item>
            </DropdownMenu.SubContent>
          </DropdownMenu.Sub>
          <DropdownMenu.Item>
            New Team
            <DropdownMenu.Shortcut>⌘+T</DropdownMenu.Shortcut>
          </DropdownMenu.Item>
        </DropdownMenu.Group>
        <DropdownMenu.Separator />
        <DropdownMenu.Item href="https://github.com/IoanCroitor/StarQA"
          >GitHub</DropdownMenu.Item
        >
        <DropdownMenu.Item href="https://github.com/IoanCroitor/StarQA/issues"
          >Support</DropdownMenu.Item
        >
        <DropdownMenu.Item href="https://github.com/IoanCroitor/StarQA"
          >Documentation</DropdownMenu.Item
        >
        <DropdownMenu.Separator />
        <DropdownMenu.Item href="/logout">
          Log out
          <DropdownMenu.Shortcut>⇧Q</DropdownMenu.Shortcut>
        </DropdownMenu.Item>
      </DropdownMenu.Content>
    </DropdownMenu.Root>
  </nav>
</div>
